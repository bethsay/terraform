Install aws cli
    #cd ~/Downloads/
    #curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o awscliv2.zip
    #unzip awscliv2.zip 
    #sudo ./aws/install
    #aws version
    #aws help

For the awscli to access our aws account, we need configure it with some credentials.
AccessKey and SecretAccessKey are required as credentials. Username and Password cannot be used.
--NEVER-- create AccessKey for your aws root account.
Create a new IAM user that has fullaccess only in S3 and IAM. On your browser, access the portal at https://us-east-1.console.aws.amazon.com/iam/home#/users/create
    ->Step1 : Provide the name "iam_admin". --uncheck-- "access to the AWS Management Console"
    ->Step2 : Attach policies directly. Search for S3 and select the policy that grants fullaccess. Do the same for IAM
    ->Step3 : Review then "Create User"
From the users list, Select the user that you have created.
Go to the "Security Credentials" tab. Click on "Create access key". Go through the steps.
Download the .csv of your accesskey and secret to a safe location on your system. OR, stay on the page until awscli config is done.
--DO NOT-- use a shared directory, network directory or a git repo directory as the download destination.
Lets configure awscli with this access
    #aws configure help
    #aws configure
        ->Paste the accesskey and secret according to the prompts
        ->Enter the aws region from which is expected to have most operations
        ->Specify the format awscli shoud use while responding to queries, ie, json, text, or table
    #aws configure list
    #cat ~/.aws/config
    #cat ~/.aws/credentials
The accesskey, secret, region, output are now associated with the "default" profile.
Any number of accesskeys and secrets pairs can be configure under unique profilenames.
The only way to remove or delete any set of credentials is by editing this credentials file.
But you can overwrite the credentials of a profile by running the import command again.
If the accesskey and secrets was downloaded as a csv file, it can be used in the import command.
    #aws configure import --csv file://iam_admin_accessKeys.csv
This command may fail, but can be fixed by editing the csv file
    #vim aws_userforiam_accessKeys.csv
        ->Prepend first line with "User Name"
        ->Prepend second line with "default" or with the username
    #aws configure import --csv file://iam_admin_accessKeys.csv
    #aws configure list-profiles
    #aws configure list
        ->If you have not used "default", use the flag --profile=username
    #cat ~/.aws/credentials
To interactively set accesskeys and secrets for the profile foo
    #aws configure --profile foo

Lets verify if the credentials work. Lets list create and destroy an s3 bucket
    #aws s3 help
    #aws s3 ls
    #aws s3 mb "s3://mynewbucket-willwork"
        ->If default region was not configured, use the flag --region=us-east-1
You can check aws console if the bucket was created or not
    #aws s3 ls
    #aws s3 rb "s3://mynewbucket-willwork"
    #aws s3 ls

Lets start using terraform to create and manage resources in this aws account of ours.
    #mkdir aws && cd aws
Use the aws provider and set it up with shared config and creds. Refer https://registry.terraform.io/providers/hashicorp/aws/latest/docs#shared-configuration-and-credentials-files
    #vim providers.tf
The config in aws providers block is optional if you are using default profile and default paths.
Install the provider and Initialize the workspace
    #terraform init
Browse the docs for resources and data blocks supported by the aws provider.
Using the aws_iam_user resource, create a user. name is a required argument. https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_user
    #vim iam.tf
Using the aws_s3_bucket resource, create a bucket. If bucket argument is skipped, it will get a random name.
    #vim s3.tf
If the bucket name is not unique, you will see errors like "BucketAlreadyExists" or "Header malformed : Wrong region"
Create the resources and check if they have been created via console or cli
    #terraform apply
    #terraform state
    #aws s3api list-buckets
    #aws iam list-users
    #aws iam get-user --user-name tf-user
Using aws_iam_access_key resource, create accesskey and secret. user is a required argument and should refer the name or id attribute of the aws_iam_user resource.
    #vim iam.tf
    #terraform apply
    #aws iam list-access-keys --user-name tf-user
    #terraform state show aws_iam_access_key.first
The aws_iam_access_key resource is created with its secret but is masked as it is a sensitive attribute. To see it,
    #less terraform.tfstate
    #terraform show -json | jq '.values.root_module.resources[] | select(.address=="aws_iam_access_key.first") | .values.secret'


The iam_admin user that we had create via aws console is only authorized to create IAM users and S3 buckets.
Terraform will use the iam_admin authorization to create IAM user with greater permissions.
The access of these codeified users will allow us to create and manage any resource in our aws account.
Lets create a workspace which we can use to manage new IAM users and their permission

